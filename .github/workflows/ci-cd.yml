# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LenkCare Homes CI/CD Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Solo Developer Workflow:
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Open PR     â”‚ â”€â”€â”€â–¶ â”‚ Build + Testâ”‚ â”€â”€â”€â–¶ â”‚ Staging     â”‚
#   â”‚ to main     â”‚      â”‚             â”‚      â”‚ Deploy      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                                   â”‚
#                              PR Closed + Merged   â”‚
#                                                   â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Merge PR    â”‚ â”€â”€â”€â–¶ â”‚ Build       â”‚ â”€â”€â”€â–¶ â”‚ Production  â”‚
#   â”‚ to main     â”‚      â”‚             â”‚      â”‚ Deploy      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Key Design Decisions:
#   â€¢ PR opened/synchronized â†’ Deploy to Staging (preview changes)
#   â€¢ PR merged to main â†’ Deploy to Production
#   â€¢ No approval gates (solo dev workflow)
#   â€¢ Concurrency controls prevent overlapping deployments
#   â€¢ Synthetic data only generated for Staging
#
# Required Secrets (per environment):
#   â€¢ AZURE_CLIENT_ID - Federated identity client ID
#   â€¢ AZURE_TENANT_ID - Azure AD tenant ID
#   â€¢ AZURE_SUBSCRIPTION_ID - Azure subscription ID
#   â€¢ AZURE_SQL_CONNECTION_STRING - SQL connection for migrations
#   â€¢ NEXT_PUBLIC_API_URL - API URL for frontend
#   â€¢ NEXT_PUBLIC_AZURE_MAPS_KEY - Azure Maps subscription key
#
# Required Variables (per environment):
#   â€¢ BACKEND_APP_SERVICE_NAME - Backend App Service name
#   â€¢ FRONTEND_APP_SERVICE_NAME - Frontend App Service name
#   â€¢ NEXT_PUBLIC_SHOW_DEV_TOOLS - Show dev tools (true for staging)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI/CD Pipeline

on:
  # PR events - deploy to staging for preview
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/instructions/**'
      - 'images/**'

  # Merge to main - deploy to production
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/instructions/**'
      - 'images/**'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ENVIRONMENT CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  DOTNET_VERSION: '10.x'
  NODE_VERSION: '24.x'
  BACKEND_WORKING_DIR: 'src/backend/LenkCareHomes/LenkCareHomes.Api'
  FRONTEND_WORKING_DIR: 'src/frontend'
  # Disable .NET CLI telemetry
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  # Suppress welcome message
  DOTNET_NOLOGO: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONCURRENCY CONTROL
# Prevents multiple deployments to the same environment simultaneously
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && 'staging' || 'production' }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SETUP
  # Determines target environment and configuration
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      generate_synthetic_data: ${{ steps.config.outputs.generate_synthetic_data }}

    steps:
      - name: Determine configuration
        id: config
        run: |
          # Determine environment based on trigger type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "environment=Staging" >> $GITHUB_OUTPUT
            echo "generate_synthetic_data=true" >> $GITHUB_OUTPUT
          else
            # push to main = production
            echo "environment=Production" >> $GITHUB_OUTPUT
            echo "generate_synthetic_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Print configuration
        run: |
          echo "## ðŸŽ¯ Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ steps.config.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Synthetic Data** | ${{ steps.config.outputs.generate_synthetic_data }} |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD BACKEND
  # Compiles .NET API and generates migration script
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Synthetic Data Generation (Staging only)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python
        if: needs.setup.outputs.generate_synthetic_data == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: src/datagen/requirements.txt

      - name: Install Python dependencies
        if: needs.setup.outputs.generate_synthetic_data == 'true'
        working-directory: src/datagen
        run: pip install -r requirements.txt

      - name: Generate synthetic data
        if: needs.setup.outputs.generate_synthetic_data == 'true'
        working-directory: src/datagen
        run: python generate.py

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # .NET Build
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        working-directory: ${{ env.BACKEND_WORKING_DIR }}
        run: dotnet restore

      - name: Build
        working-directory: ${{ env.BACKEND_WORKING_DIR }}
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        working-directory: ${{ env.BACKEND_WORKING_DIR }}
        run: dotnet publish -c Release -o ${{ runner.temp }}/backend-publish --no-build

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Generate Migration Script
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Generate migration script
        working-directory: ${{ env.BACKEND_WORKING_DIR }}
        run: |
          mkdir -p ${{ runner.temp }}/migrations
          dotnet ef migrations script --idempotent --output ${{ runner.temp }}/migrations/migration-script.sql
        env:
          # EF needs a connection string to generate script (won't actually connect)
          ConnectionStrings__SqlDatabase: "Server=placeholder;Database=placeholder;User Id=placeholder;Password=placeholder;"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload Artifacts
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ${{ runner.temp }}/backend-publish
          retention-days: 1

      - name: Upload migration script artifact
        uses: actions/upload-artifact@v4
        with:
          name: migration-script
          path: ${{ runner.temp }}/migrations/migration-script.sql
          retention-days: 1
          if-no-files-found: warn

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD FRONTEND
  # Compiles Next.js application with environment-specific configuration
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-frontend:
    name: Build Frontend (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      contents: read
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_WORKING_DIR }}
        run: npm ci

      - name: Build
        working-directory: ${{ env.FRONTEND_WORKING_DIR }}
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_AZURE_MAPS_KEY: ${{ secrets.NEXT_PUBLIC_AZURE_MAPS_KEY }}
          NEXT_PUBLIC_SHOW_DEV_TOOLS: ${{ vars.NEXT_PUBLIC_SHOW_DEV_TOOLS }}
        run: npm run build

      - name: Prepare standalone deployment package
        working-directory: ${{ env.FRONTEND_WORKING_DIR }}
        run: |
          # Copy static assets to the standalone output
          cp -r public .next/standalone/public
          cp -r .next/static .next/standalone/.next/static
          # Rename .next to next (no dot) to preserve in artifact
          mv .next/standalone/.next .next/standalone/next

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.FRONTEND_WORKING_DIR }}/.next/standalone
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # APPLY MIGRATIONS
  # Applies database migrations to target environment
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  apply-migrations:
    name: Apply Migrations (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, build-backend]
    environment: ${{ needs.setup.outputs.environment }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download migration script
        uses: actions/download-artifact@v4
        with:
          name: migration-script
          path: ./migrations
        continue-on-error: true

      - name: Check if migrations exist
        id: check-migrations
        run: |
          if [ -f "./migrations/migration-script.sql" ]; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            # Check if it's an empty migration (only comments/whitespace)
            if grep -qE "^[^-]" ./migrations/migration-script.sql 2>/dev/null; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "Migration script contains no actual changes."
            fi
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No migration script found."
          fi

      - name: Azure Login
        if: steps.check-migrations.outputs.has_migrations == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Apply migrations
        if: steps.check-migrations.outputs.has_migrations == 'true'
        uses: azure/sql-action@v2.3
        with:
          connection-string: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
          path: ./migrations/migration-script.sql

      - name: Migration summary
        run: |
          echo "## ðŸ—ƒï¸ Migration Results (${{ needs.setup.outputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-migrations.outputs.has_migrations }}" == "true" ]; then
            echo "âœ… Migrations applied successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No pending migrations to apply." >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY BACKEND
  # Deploys the backend API to Azure App Service
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-backend:
    name: Deploy Backend (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, build-backend, apply-migrations]
    if: needs.build-backend.result == 'success' && needs.apply-migrations.result == 'success'
    environment: 
      name: ${{ needs.setup.outputs.environment }}
      url: https://${{ vars.BACKEND_APP_SERVICE_NAME }}.azurewebsites.net
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.BACKEND_APP_SERVICE_NAME }}
          package: ./backend

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Backend Deployment (${{ needs.setup.outputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployed to:** \`${{ vars.BACKEND_APP_SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **URL:** https://${{ vars.BACKEND_APP_SERVICE_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY FRONTEND
  # Deploys the Next.js frontend to Azure App Service
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-frontend:
    name: Deploy Frontend (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, build-frontend, apply-migrations]
    if: needs.build-frontend.result == 'success' && needs.apply-migrations.result == 'success'
    environment: 
      name: ${{ needs.setup.outputs.environment }}
      url: https://${{ vars.FRONTEND_APP_SERVICE_NAME }}.azurewebsites.net
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend

      - name: Restore .next folder name
        working-directory: ./frontend
        run: mv next .next

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.FRONTEND_APP_SERVICE_NAME }}
          package: ./frontend

      - name: Deployment summary
        run: |
          echo "## ðŸŽ¨ Frontend Deployment (${{ needs.setup.outputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployed to:** \`${{ vars.FRONTEND_APP_SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **URL:** https://${{ vars.FRONTEND_APP_SERVICE_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PR COMMENT (Staging Only)
  # Posts deployment status to the PR for easy access
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [setup, deploy-backend, deploy-frontend]
    if: github.event_name == 'pull_request' && always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    environment: ${{ needs.setup.outputs.environment }}
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const backendUrl = `https://${{ vars.BACKEND_APP_SERVICE_NAME }}.azurewebsites.net`;
            const frontendUrl = `https://${{ vars.FRONTEND_APP_SERVICE_NAME }}.azurewebsites.net`;
            const backendStatus = '${{ needs.deploy-backend.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const frontendStatus = '${{ needs.deploy-frontend.result }}' === 'success' ? 'âœ…' : 'âŒ';
            
            const body = `## ðŸš€ Staging Deployment Complete
            
            | Component | Status | URL |
            |-----------|--------|-----|
            | Frontend | ${frontendStatus} | [${frontendUrl}](${frontendUrl}) |
            | Backend API | ${backendStatus} | [${backendUrl}](${backendUrl}) |
            
            ---
            
            **Commit:** \`${{ github.sha }}\`
            **Workflow:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            > ðŸ’¡ **Tip:** Merge this PR to deploy to Production.`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸš€ Staging Deployment Complete')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOYMENT COMPLETE
  # Final summary of the entire deployment
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [setup, build-backend, build-frontend, apply-migrations, deploy-backend, deploy-frontend]
    if: always()
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Generate final summary
        run: |
          echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Build Backend
          if [ "${{ needs.build-backend.result }}" = "success" ]; then
            echo "| Build Backend | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-backend.result }}" = "skipped" ]; then
            echo "| Build Backend | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build Backend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build Frontend
          if [ "${{ needs.build-frontend.result }}" = "success" ]; then
            echo "| Build Frontend | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-frontend.result }}" = "skipped" ]; then
            echo "| Build Frontend | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build Frontend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Migrations
          if [ "${{ needs.apply-migrations.result }}" = "success" ]; then
            echo "| Apply Migrations | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.apply-migrations.result }}" = "skipped" ]; then
            echo "| Apply Migrations | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Apply Migrations | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Deploy Backend
          if [ "${{ needs.deploy-backend.result }}" = "success" ]; then
            echo "| Deploy Backend | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-backend.result }}" = "skipped" ]; then
            echo "| Deploy Backend | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Deploy Backend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Deploy Frontend
          if [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
            echo "| Deploy Frontend | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-frontend.result }}" = "skipped" ]; then
            echo "| Deploy Frontend | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Deploy Frontend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [ "${{ needs.deploy-backend.result }}" = "success" ] && [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Frontend:** https://${{ vars.FRONTEND_APP_SERVICE_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Backend:** https://${{ vars.BACKEND_APP_SERVICE_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Deployment completed with issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
